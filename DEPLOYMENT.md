# Render Deployment Guide

## Prerequisites
- GitHub account
- Spotify Developer account with app credentials
- Code pushed to a GitHub repository

## Environment Variables

### Backend (music-queue-api)
These will be set in Render's dashboard:

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | Auto-populated by Render | (auto) |
| `CLIENT_URL` | Your frontend URL | `https://music-queue-client.onrender.com` |
| `SPOTIFY_CLIENT_ID` | From Spotify Developer Dashboard | Your Spotify Client ID |
| `SPOTIFY_CLIENT_SECRET` | From Spotify Developer Dashboard | Your Spotify Secret |
| `SPOTIFY_REDIRECT_URI` | Backend URL + /api/auth/callback | `https://music-queue-api.onrender.com/api/auth/callback` |
| `SESSION_SECRET` | Auto-generated by Render | (auto) |
| `PORT` | Set to 10000 | `10000` |
| `NODE_ENV` | Set to production | `production` |

### Frontend (music-queue-client)
| Variable | Description | Example |
|----------|-------------|---------|
| `VITE_API_URL` | Your backend URL | `https://music-queue-api.onrender.com` |

## Step-by-Step Deployment

### Step 1: Prepare Your Code
1. Ensure all changes are committed:
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

### Step 2: Create Render Account
1. Go to [https://render.com](https://render.com)
2. Sign up with your GitHub account
3. Authorize Render to access your repositories

### Step 3: Deploy Using Blueprint (render.yaml)

#### Option A: Deploy via Dashboard
1. Click "New" → "Blueprint"
2. Connect your GitHub repository
3. Select the repository containing your code
4. Render will detect `render.yaml` automatically
5. Click "Apply" to create all services

#### Option B: Manual Setup (if blueprint doesn't work)

**Create Database:**
1. Click "New" → "PostgreSQL"
2. Name: `music-queue-db`
3. Database: `musicqueue`
4. Region: Oregon (or closest to you)
5. Plan: Free
6. Click "Create Database"
7. **Save the Internal Database URL** for later

**Create Backend Service:**
1. Click "New" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - Name: `music-queue-api`
   - Region: Oregon
   - Root Directory: (leave blank)
   - Runtime: Node
   - Build Command: `cd server && npm install`
   - Start Command: `cd server && npm start`
   - Plan: Free
4. Add Environment Variables (see table above)
5. Click "Create Web Service"

**Create Frontend Service:**
1. Click "New" → "Static Site"
2. Connect your GitHub repository
3. Configure:
   - Name: `music-queue-client`
   - Root Directory: (leave blank)
   - Build Command: `cd client && npm install && npm run build`
   - Publish Directory: `client/dist`
4. Add Environment Variable:
   - `VITE_API_URL`: `https://music-queue-api.onrender.com` (use your actual backend URL)
5. Click "Create Static Site"

### Step 4: Configure Spotify Developer App
1. Go to [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Select your app
3. Click "Settings"
4. Add Redirect URI:
   - `https://music-queue-api.onrender.com/api/auth/callback`
   - (Replace with your actual backend URL)
5. Save changes

### Step 5: Set Environment Variables in Render

**For Backend Service:**
1. Go to your `music-queue-api` service
2. Click "Environment" in the left sidebar
3. Add the variables from the table above
4. Important URLs to set:
   - `CLIENT_URL`: Your frontend URL (e.g., `https://music-queue-client.onrender.com`)
   - `SPOTIFY_REDIRECT_URI`: `https://music-queue-api.onrender.com/api/auth/callback`
5. Click "Save Changes" (service will auto-redeploy)

**For Frontend Service:**
1. Go to your `music-queue-client` service
2. Click "Environment" in the left sidebar
3. Add:
   - `VITE_API_URL`: Your backend URL (e.g., `https://music-queue-api.onrender.com`)
4. Click "Save Changes" (service will auto-redeploy)

### Step 6: Initialize Database
1. Go to your backend service dashboard
2. Click "Shell" tab
3. Run your database migrations/setup commands if you have any
   ```bash
   # Example - adjust based on your setup
   cd server
   npm run migrate
   ```

### Step 7: Verify Deployment
1. Visit your frontend URL (e.g., `https://music-queue-client.onrender.com`)
2. Check browser console for connection logs
3. Test Spotify authentication
4. Verify websocket connections are working

## Important Notes

### Free Tier Limitations
- Services spin down after 15 minutes of inactivity
- First request after inactivity takes ~30 seconds (cold start)
- Database has limited storage (1GB)
- 750 hours/month of runtime per service

### Debugging
- Check logs in Render dashboard under "Logs" tab
- Monitor "Events" tab for deployment status
- Use browser DevTools to check websocket connections

### CORS Configuration
Your backend should already have CORS configured in the code. Verify it's pointing to your CLIENT_URL.

### Database Connection
Render automatically provides `DATABASE_URL` to your backend service when you link the database.

## Troubleshooting

### Issue: "Cannot connect to server"
- Verify `VITE_API_URL` in frontend matches your backend URL
- Check backend logs for errors
- Ensure backend service is running (not sleeping)

### Issue: "Spotify authentication fails"
- Verify `SPOTIFY_REDIRECT_URI` matches in both:
  - Spotify Developer Dashboard
  - Backend environment variables
- Check `CLIENT_URL` is set correctly

### Issue: "Websocket connection fails"
- Websockets work on Render by default
- Check browser console for connection errors
- Verify backend is listening on `0.0.0.0` (already updated)

### Issue: "Service won't start"
- Check build logs for npm install errors
- Verify all required environment variables are set
- Ensure database is created and linked

## Updating Your App
Render auto-deploys when you push to GitHub:
```bash
git add .
git commit -m "Your changes"
git push origin main
```

Services will automatically rebuild and redeploy.

## Cost
Free tier includes:
- Web services: 750 hours/month
- PostgreSQL: 1GB storage, 97 hours/month
- Static sites: 100GB bandwidth/month

This is sufficient for development and small-scale production use.
